<section class="controls">
  <div class="region-controls">
    <button type="button" (click)="setRegion('eu')" [disabled]="region === 'eu'">EU</button>
    <button type="button" (click)="setRegion('us')" [disabled]="region === 'us'">US</button>
  </div>
  <div class="bracket-controls">
    @for (option of brackets; track option) {
      <button
        type="button"
        (click)="setBracket(option)"
        [class.active]="option === bracket"
      >
        {{ option.toUpperCase() }}
      </button>
    }
  </div>
</section>

@if (loading) {
  <div class="status">Loading leaderboard...</div>
} @else if (error) {
  <div class="error">{{ error }}</div>
} @else if (rows.length) {
  <table class="leaderboard-table">
    <thead>
      <tr>
        <th class="col-rank">#</th>
        <th class="col-player">Player</th>
        <th class="col-realm">Realm</th>
        <th class="col-record">Record</th>
        <th class="col-rating">Rating</th>
      </tr>
    </thead>
    <tbody>
      @for (row of rows; track trackByRow($index, row)) {
        <tr>
          <td class="rank-cell">#{{ row.rank ?? '-' }}</td>
          <td class="player-cell">
            <div class="player-stack">
              <div class="icon-stack">
                <img
                  class="class-icon"
                  [src]="classIcon(row)"
                  [alt]="row.className"
                  (error)="onIconError($event)"
                  loading="lazy"
                />
                @if (raceIcon(row); as raceIconUrl) {
                  <img
                    class="race-icon"
                    [src]="raceIconUrl"
                    [alt]="row.race ?? 'Race icon'"
                    loading="lazy"
                    (error)="onRaceIconError($event)"
                  />
                }
              </div>
              <div class="player-meta">
                <a
                  class="player-name"
                  [routerLink]="[
                    '/player',
                    region,
                    row.realmSlug,
                    row.routeName
                  ]"
                  [queryParams]="{
                    rating: row.rating ?? undefined,
                    class: row.className,
                    race: row.race ?? undefined,
                    spec: row.specName ?? undefined,
                    bracket: bracket,
                    realmName: row.realmName,
                    wins: row.wins ?? undefined,
                    losses: row.losses ?? undefined
                  }"
                >
                  {{ row.name }}
                </a>
                <span class="player-spec">
                  {{ row.specName ?? row.className }}
                </span>
              </div>
            </div>
          </td>
          <td class="realm-cell">
            <span [class]="realmClass(row)">
              {{ row.realmName }}
            </span>
          </td>
          <td class="record-cell">
            <span class="wins">{{ record(row, 'wins') }}</span>
            <span class="divider">/</span>
            <span class="losses">{{ record(row, 'losses') }}</span>
          </td>
          <td class="rating-cell">{{ row.rating ?? '-' }}</td>
        </tr>
      } @empty {
        <tr>
          <td colspan="5" class="empty-cell">No results.</td>
        </tr>
      }
    </tbody>
  </table>
} @else {
  <div class="status">No results for this bracket yet.</div>
}

<div class="pager">
  <button type="button" (click)="loadPage(currentPage - 1)" [disabled]="currentPage <= 1">Prev</button>
  <span>Page {{ currentPage }} / {{ totalPages }}</span>
  <span class="total">Showing {{ rows.length }} of {{ totalEntries }} entries</span>
  <button type="button" (click)="loadPage(currentPage + 1)" [disabled]="currentPage >= totalPages">
    Next
  </button>
</div>
